<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Buildings Planner</title>
    <style>
        :root {
            --grid-size: 50;
            --cell-size: 12px;
            --alliance-color: rgba(0, 128, 255, 0.3);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
        }

        .language-btn {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .language-btn.active {
            background-color: white;
            color: #333;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .grid-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background-color: #f0f0f0;
            user-select: none;
            touch-action: none;
        }

        .building-item.dragging {
            opacity: 0.5;
        }

        .grid {
            display: grid;
            background-color: white;
            margin: 20px;
            position: relative;
        }

        .grid-cell {
            border: 1px solid #ddd;
            box-sizing: border-box;
            position: relative;
        }

        .toolbar {
            width: 200px;
            background-color: #f8f8f8;
            padding: 10px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }

        .building-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .building-item .icon {
            font-size: 24px;
        }

        .building-list {
            background-color: #f8f8f8;
            padding: 10px;
            border-top: 1px solid #ddd;
            height: 150px;
            overflow-y: auto;
        }

        .tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }

        .list-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item.selected {
            background-color: #e6f7ff;
            border-color: #91d5ff;
        }

        .building {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid #333;
            box-sizing: border-box;
            cursor: move;
            z-index: 10;
            font-size: 24px;
            overflow: hidden;
            user-select: none;
        }

        .building.selected {
            border-color: #1890ff;
            box-shadow: 0 0 10px rgba(24, 144, 255, 0.5);
        }

        .building-area {
            position: absolute;
            background-color: var(--alliance-color);
            z-index: 5;
            pointer-events: none;
        }

        .player-castle-name {
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 4px;
            width: 300px;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 20px;
        }

        input,
        button {
            padding: 8px;
            margin: 5px 0;
        }

        .config-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        header-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-size-input {
            width: 50px;
            height: 30px;
            padding: 0 5px;
        }

        .header-btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #1890ff;
            bottom: 0;
            right: 0;
            cursor: nwse-resize;
            z-index: 11;
        }

        .deadzone-name {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 2px;
            background-color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .toolbar {
                width: 100%;
                border-left: none;
                border-top: 1px solid #ddd;
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
            }

            .building-item {
                width: 80px;
                margin: 5px;
            }

            .grid-container {
                height: 60vh;
            }

            .building-item .building-name {
                display: none;
            }

            .building-item {
                width: auto;
                justify-content: center;
                padding: 8px;
            }

            .building-item .icon {
                font-size: 28px;
                /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
            }

            /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–¥–ø–∏—Å–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            .building-item.dragging .building-name {
                display: block;
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(255, 255, 255, 0.9);
                padding: 4px 8px;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                white-space: nowrap;
                z-index: 100;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1 id="title">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–¥–∞–Ω–∏–π –∞–ª—å—è–Ω—Å–∞</h1>
        <div class="header-buttons">
            <button id="saveButton" class="header-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <label id="grid-size-label" for="gridSizeInput">–†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏:</label>
            <input type="number" id="gridSizeInput" class="grid-size-input" min="10" max="100" value="50">
            <button id="applyGridSize" data-key="apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="language-switcher">
            <button class="language-btn active" data-lang="ru">RU</button>
            <button class="language-btn" data-lang="en">EN</button>
        </div>
    </header>

    <div class="main-container">
        <div class="toolbar" id="toolbar">
            <h2 id="buildings-header">–ó–¥–∞–Ω–∏—è</h2>
            <div class="building-item" draggable="true" data-type="fortress">
                <div class="icon">üè∞</div>
                <div class="building-name" data-key="fortress">–ö—Ä–µ–ø–æ—Å—Ç—å –∞–ª—å—è–Ω—Å–∞</div>
            </div>
            <div class="building-item" draggable="true" data-type="outpost">
                <div class="icon">üö©</div>
                <div class="building-name" data-key="outpost">–§–æ—Ä–ø–æ—Å—Ç –∞–ª—å—è–Ω—Å–∞</div>
            </div>
            <div class="building-item" draggable="true" data-type="hellgates">
                <div class="icon">üëπ</div>
                <div class="building-name" data-key="hellgates">–ê–¥—Å–∫–∏–µ –≤—Ä–∞—Ç–∞</div>
            </div>
            <div class="building-item" draggable="true" data-type="hospital">
                <div class="icon">üè•</div>
                <div class="building-name" data-key="hospital">–ì–æ—Å–ø–∏—Ç–∞–ª—å</div>
            </div>
            <div class="building-item" draggable="true" data-type="farm">
                <div class="icon">üåæ</div>
                <div class="building-name" data-key="farm">–§–µ—Ä–º–∞</div>
            </div>
            <div class="building-item" draggable="true" data-type="warehouse">
                <div class="icon">üè≠</div>
                <div class="building-name" data-key="warehouse">–°–∫–ª–∞–¥</div>
            </div>
            <div class="building-item" draggable="true" data-type="castle">
                <div class="icon">üèØ</div>
                <div class="building-name" data-key="castle">–ó–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞</div>
            </div>
            <div class="building-item" draggable="true" data-type="deadzone">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="building-name" data-key="deadzone">–ú–µ—Ä—Ç–≤–∞—è –∑–æ–Ω–∞</div>
            </div>
        </div>

        <div class="grid-container">
            <div class="grid" id="grid"></div>
        </div>
    </div>

    <div class="building-list">
        <h3 id="buildings-list-header">–°–ø–∏—Å–æ–∫ –∑–¥–∞–Ω–∏–π</h3>
        <div id="buildings-list"></div>
    </div>

    <div id="playerNameModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title">–ò–º—è –∏–≥—Ä–æ–∫–∞</h2>
            <input type="text" id="playerNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞">
            <button id="savePlayerName" data-key="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="renameModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="rename-modal-title">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∑–∞–º–æ–∫</h2>
            <input type="text" id="renameInput">
            <button id="saveRename" data-key="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
        const translations = {
            ru: {
                title: "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–¥–∞–Ω–∏–π –∞–ª—å—è–Ω—Å–∞",
                buildingsHeader: "–ó–¥–∞–Ω–∏—è",
                buildingsListHeader: "–°–ø–∏—Å–æ–∫ –∑–¥–∞–Ω–∏–π",
                modalTitle: "–ò–º—è –∏–≥—Ä–æ–∫–∞",
                renameModalTitle: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∑–∞–º–æ–∫",
                gridSizeLabel: "–†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏:",
                apply: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
                save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                fortress: "–ö—Ä–µ–ø–æ—Å—Ç—å –∞–ª—å—è–Ω—Å–∞",
                outpost: "–§–æ—Ä–ø–æ—Å—Ç –∞–ª—å—è–Ω—Å–∞",
                hellgates: "–ê–¥—Å–∫–∏–µ –≤—Ä–∞—Ç–∞",
                hospital: "–ì–æ—Å–ø–∏—Ç–∞–ª—å",
                farm: "–§–µ—Ä–º–∞",
                warehouse: "–°–∫–ª–∞–¥",
                castle: "–ó–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞",
                deadzone: "–ú–µ—Ä—Ç–≤–∞—è –∑–æ–Ω–∞",
                rename: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å",
                delete: "–£–¥–∞–ª–∏—Ç—å",
                playerName: "–ò–º—è –∏–≥—Ä–æ–∫–∞",
                save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                saveButton: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
            },
            en: {
                title: "Alliance Buildings Planner",
                buildingsHeader: "Buildings",
                buildingsListHeader: "Buildings List",
                modalTitle: "Player Name",
                renameModalTitle: "Rename Castle",
                gridSizeLabel: "Grid Size:",
                apply: "Apply",
                save: "Save",
                fortress: "Alliance Fortress",
                outpost: "Alliance Outpost",
                hellgates: "Hell Gates",
                hospital: "Hospital",
                farm: "Farm",
                warehouse: "Warehouse",
                castle: "Player Castle",
                deadzone: "Dead Zone",
                rename: "Rename",
                delete: "Delete",
                playerName: "Player Name",
                save: "Save",
                saveButton: "Save",
            }
        };

        let currentLang = 'ru';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–¥–∞–Ω–∏–π
        const buildingConfig = {
            fortress: { icon: 'üè∞', size: 3, areaSize: 15, limit: 1, type: 'alliance' },
            outpost: { icon: 'üö©', size: 2, areaSize: 10, limit: 5, type: 'alliance' },
            hellgates: { icon: 'üëπ', size: 3, areaSize: 0, limit: 1, type: 'alliance' },
            hospital: { icon: 'üè•', size: 2, areaSize: 0, limit: 1, type: 'alliance' },
            farm: { icon: 'üåæ', size: 2, areaSize: 0, limit: 1, type: 'alliance' },
            warehouse: { icon: 'üè≠', size: 2, areaSize: 0, limit: 1, type: 'alliance' },
            castle: { icon: 'üèØ', size: 2, areaSize: 0, limit: -1, type: 'player' },
            deadzone: { icon: '‚ö†Ô∏è', size: 1, areaSize: 0, limit: -1, type: 'special', bgcolor: 'rgba(144, 238, 144, 0.5)' },
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let buildings = [];
        let selectedBuilding = null;
        let gridSize = 50;
        let cellSize = 24; // px

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setupGrid();
            setupDragAndDrop();
            setupEventListeners();
            updateBuildingsList();
            updateLanguage();
            checkLocationHash();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏
        function setupGrid() {
            const grid = document.getElementById('grid');
            grid.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
            grid.style.gridTemplateRows = `repeat(${gridSize}, ${cellSize}px)`;

            grid.innerHTML = '';
            for (let i = 0; i < gridSize * gridSize; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                grid.appendChild(cell);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        function setupDragAndDrop() {
            const buildingItems = document.querySelectorAll('.building-item');
            const grid = document.getElementById('grid');

            buildingItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.type);
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });

            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            grid.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('text/plain');
                const rect = grid.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / cellSize);
                const y = Math.floor((e.clientY - rect.top) / cellSize);

                if (type === 'castle') {
                    showPlayerNameModal(x, y);
                } else {
                    createBuilding(type, x, y);
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
            const playerNameModal = document.getElementById('playerNameModal');
            const closeButtons = document.querySelectorAll('.close');
            const savePlayerNameButton = document.getElementById('savePlayerName');

            setupTouchEvents();
            setupTouchDragAndDrop();

            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    playerNameModal.style.display = 'none';
                    document.getElementById('renameModal').style.display = 'none';
                });
            });

            savePlayerNameButton.addEventListener('click', () => {
                const x = parseInt(playerNameModal.dataset.x);
                const y = parseInt(playerNameModal.dataset.y);
                const playerName = document.getElementById('playerNameInput').value;

                createBuilding('castle', x, y, playerName);
                playerNameModal.style.display = 'none';
                document.getElementById('playerNameInput').value = '';
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏
            const saveRenameButton = document.getElementById('saveRename');
            saveRenameButton.addEventListener('click', () => {
                const buildingId = document.getElementById('renameModal').dataset.buildingId;
                const newName = document.getElementById('renameInput').value;

                const building = buildings.find(b => b.id === buildingId);
                if (building) {
                    building.playerName = newName;
                    updateBuilding(building);
                    updateBuildingsList();
                }

                document.getElementById('renameModal').style.display = 'none';
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
            const langButtons = document.querySelectorAll('.language-btn');
            langButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    langButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateLanguage();
                });
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–µ—Ç–∫–∏
            const applyGridSizeButton = document.getElementById('applyGridSize');
            applyGridSizeButton.addEventListener('click', () => {
                const newSize = parseInt(document.getElementById('gridSizeInput').value);
                if (newSize >= 10 && newSize <= 100) {
                    gridSize = newSize;
                    setupGrid();
                    redrawAllBuildings();
                }
            });

            const saveButton = document.getElementById('saveButton');
            saveButton.addEventListener('click', saveStateToBase64);

            window.addEventListener('resize', checkScreenSize);
            checkScreenSize(); // –í—ã–∑–≤–∞—Ç—å —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
        function showPlayerNameModal(x, y) {
            const modal = document.getElementById('playerNameModal');
            modal.dataset.x = x;
            modal.dataset.y = y;
            modal.style.display = 'block';
            document.getElementById('playerNameInput').focus();
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∑–∞–º–∫–∞
        function showRenameModal(buildingId) {
            const building = buildings.find(b => b.id === buildingId);
            if (!building) return;

            const modal = document.getElementById('renameModal');
            modal.dataset.buildingId = buildingId;
            document.getElementById('renameInput').value = building.playerName || '';
            modal.style.display = 'block';
            document.getElementById('renameInput').focus();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è
        function createBuilding(type, x, y, playerName = '') {
            const config = buildingConfig[type];
            if (!config) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∑–¥–∞–Ω–∏–π
            if (config.limit > 0) {
                const count = buildings.filter(b => b.type === type).length;
                if (count >= config.limit) {
                    alert(currentLang === 'ru' ?
                        `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–¥–∞–Ω–∏–π —Ç–∏–ø–∞ ${translations[currentLang][type]}` :
                        `Building limit reached for ${translations[currentLang][type]}`);
                    return;
                }
            }

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–¥–∞–Ω–∏–π —Ä–∞–∑–º–µ—Ä–æ–º –±–æ–ª—å—à–µ 1x1
            if (config.size > 1) {
                x = Math.max(0, Math.min(gridSize - config.size, x));
                y = Math.max(0, Math.min(gridSize - config.size, y));
            } else {
                x = Math.max(0, Math.min(gridSize - 1, x));
                y = Math.max(0, Math.min(gridSize - 1, y));
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–¥–∞–Ω–∏—è–º–∏
            if (checkOverlap(x, y, config.size, config.size)) {
                alert(currentLang === 'ru' ?
                    '–ó–¥–∞–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è!' :
                    'Buildings cannot overlap!');
                return;
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∑–¥–∞–Ω–∏—è
            const newBuilding = {
                id: Date.now().toString(),
                type: type,
                x: x,
                y: y,
                playerName: type === 'castle' ? playerName : '',
                size: config.size,
                areaSize: config.areaSize,
                icon: config.icon
            };

            buildings.push(newBuilding);
            addBuildingToGrid(newBuilding);
            updateBuildingsList();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–¥–∞–Ω–∏—è–º–∏
        function checkOverlap(x, y, width, height) {
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –æ–¥–∏–Ω —Ä–∞–∑–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –æ–±–æ–∏—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
            if (height === undefined) {
                height = width;
            }

            for (const building of buildings) {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –∑–¥–∞–Ω–∏—è
                const buildingWidth = building.width || building.size;
                const buildingHeight = building.height || building.size;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –º–µ–∂–¥—É –∑–¥–∞–Ω–∏—è–º–∏
                if (x < building.x + buildingWidth &&
                    x + width > building.x &&
                    y < building.y + buildingHeight &&
                    y + height > building.y) {
                    return true;
                }
            }
            return false;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è –Ω–∞ —Å–µ—Ç–∫—É
        function addBuildingToGrid(building) {
            const grid = document.getElementById('grid');

            // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –≤–ª–∏—è–Ω–∏—è –¥–ª—è –∑–¥–∞–Ω–∏–π —Å areaSize > 0
            if (building.areaSize > 0) {
                const area = document.createElement('div');
                area.className = 'building-area';
                area.id = `area-${building.id}`;

                const offset = Math.floor((building.areaSize - building.size) / 2);
                const areaX = building.x - offset;
                const areaY = building.y - offset;

                area.style.left = `${areaX * cellSize}px`;
                area.style.top = `${areaY * cellSize}px`;
                area.style.width = `${building.areaSize * cellSize}px`;
                area.style.height = `${building.areaSize * cellSize}px`;

                grid.appendChild(area);
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–≥–æ –∑–¥–∞–Ω–∏—è
            const buildingEl = document.createElement('div');
            buildingEl.className = 'building';
            buildingEl.id = `building-${building.id}`;
            buildingEl.dataset.id = building.id;

            buildingEl.style.left = `${building.x * cellSize}px`;
            buildingEl.style.top = `${building.y * cellSize}px`;
            buildingEl.style.width = `${building.size * cellSize}px`;
            buildingEl.style.height = `${building.size * cellSize}px`;

            // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–¥–∞–Ω–∏—è
            if (building.type !== 'castle') {
                const icon = document.createElement('div');
                icon.textContent = building.icon;
                buildingEl.appendChild(icon);

                // Add name display for deadzone if it exists
                if (building.type === 'deadzone' && building.playerName) {
                    const nameEl = document.createElement('div');
                    nameEl.className = 'deadzone-name';
                    nameEl.textContent = building.playerName;
                    nameEl.style.marginLeft = '5px';
                    buildingEl.appendChild(nameEl);
                }
            }

            // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–º–æ–∫ –∏–≥—Ä–æ–∫–∞, –¥–æ–±–∞–≤–∏—Ç—å –∏–º—è
            if (building.type === 'castle' && building.playerName) {
                const nameEl = document.createElement('div');
                nameEl.className = 'player-castle-name';
                nameEl.textContent = building.playerName;
                buildingEl.appendChild(nameEl);
            }
            if (building.type === 'castle') {
                buildingEl.style.backgroundColor = 'rgba(255, 255, 255, 0.7)'; // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π
            }

            // Add this line at the end of the addBuildingToGrid function
            if (building.type === 'deadzone') {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ, —É—Å—Ç–∞–Ω–æ–≤–∏–º width –∏ height —Ä–∞–≤–Ω—ã–º–∏ size
                if (!building.width) building.width = building.size;
                if (!building.height) building.height = building.size;

                buildingEl.style.backgroundColor = buildingConfig[building.type].bgcolor;
                buildingEl.style.width = `${building.width * cellSize}px`;
                buildingEl.style.height = `${building.height * cellSize}px`;

                makeDeadZoneResizable(buildingEl, building);
            } else {
                buildingEl.style.width = `${building.size * cellSize}px`;
                buildingEl.style.height = `${building.size * cellSize}px`;
            }

            addTouchHandlersToBuilding(buildingEl, building);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            buildingEl.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
                    selectBuilding(building.id);

                    // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startBuildingX = building.x;
                    const startBuildingY = building.y;

                    const handleMouseMove = (moveEvent) => {
                        const deltaX = Math.floor((moveEvent.clientX - startX) / cellSize);
                        const deltaY = Math.floor((moveEvent.clientY - startY) / cellSize);

                        const newX = Math.max(0, Math.min(gridSize - building.size, startBuildingX + deltaX));
                        const newY = Math.max(0, Math.min(gridSize - building.size, startBuildingY + deltaY));

                        // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—å –∑–¥–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
                        const index = buildings.findIndex(b => b.id === building.id);
                        const tempBuilding = buildings.splice(index, 1)[0];

                        if (!checkOverlap(newX, newY, building.size)) {
                            building.x = newX;
                            building.y = newY;
                            updateBuilding(building);
                        }

                        // –í–µ—Ä–Ω—É—Ç—å –∑–¥–∞–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤
                        buildings.splice(index, 0, tempBuilding);
                    };

                    const handleMouseUp = () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }
            });

            grid.appendChild(buildingEl);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –∑–¥–∞–Ω–∏—è
        function updateBuilding(building) {
            const buildingEl = document.getElementById(`building-${building.id}`);
            if (!buildingEl) return;

            buildingEl.style.left = `${building.x * cellSize}px`;
            buildingEl.style.top = `${building.y * cellSize}px`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –≤–ª–∏—è–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (building.areaSize > 0) {
                const areaEl = document.getElementById(`area-${building.id}`);
                if (areaEl) {
                    const offset = Math.floor((building.areaSize - building.size) / 2);
                    const areaX = building.x - offset;
                    const areaY = building.y - offset;

                    areaEl.style.left = `${areaX * cellSize}px`;
                    areaEl.style.top = `${areaY * cellSize}px`;
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –¥–ª—è –∑–∞–º–∫–∞ –∏–≥—Ä–æ–∫–∞
            if (building.type === 'castle') {
                let nameEl = buildingEl.querySelector('.player-castle-name');
                if (!nameEl && building.playerName) {
                    nameEl = document.createElement('div');
                    nameEl.className = 'player-castle-name';
                    buildingEl.appendChild(nameEl);
                }

                if (nameEl) {
                    nameEl.textContent = building.playerName || '';
                }
            }

            // if (building.type === 'deadzone') {
            //     buildingEl.style.width = `${building.width * cellSize}px`;
            //     buildingEl.style.height = `${building.height * cellSize}px`;
            // } else {
            //     buildingEl.style.width = `${building.size * cellSize}px`;
            //     buildingEl.style.height = `${building.size * cellSize}px`;
            // }

            if (building.type === 'deadzone') {
                let nameEl = buildingEl.querySelector('.deadzone-name');
                if (!nameEl && building.playerName) {
                    nameEl = document.createElement('div');
                    nameEl.className = 'deadzone-name';
                    nameEl.style.marginLeft = '5px';
                    buildingEl.appendChild(nameEl);
                }

                if (nameEl) {
                    nameEl.textContent = building.playerName || '';
                }
            }
        }

        // –í—ã–±–æ—Ä –∑–¥–∞–Ω–∏—è
        function selectBuilding(id) {
            // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–¥–∞–Ω–∏—è
            if (selectedBuilding) {
                const prevEl = document.getElementById(`building-${selectedBuilding}`);
                if (prevEl) prevEl.classList.remove('selected');

                const prevListItem = document.getElementById(`list-item-${selectedBuilding}`);
                if (prevListItem) prevListItem.classList.remove('selected');
            }

            selectedBuilding = id;

            // –í—ã–¥–µ–ª–∏—Ç—å –Ω–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ
            if (selectedBuilding) {
                const buildingEl = document.getElementById(`building-${selectedBuilding}`);
                if (buildingEl) buildingEl.classList.add('selected');

                const listItem = document.getElementById(`list-item-${selectedBuilding}`);
                if (listItem) {
                    listItem.classList.add('selected');
                    listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è
        function deleteBuilding(id) {
            const index = buildings.findIndex(b => b.id === id);
            if (index === -1) return;

            const building = buildings[index];
            buildings.splice(index, 1);

            // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å DOM
            const buildingEl = document.getElementById(`building-${id}`);
            if (buildingEl) buildingEl.remove();

            if (building.areaSize > 0) {
                const areaEl = document.getElementById(`area-${id}`);
                if (areaEl) areaEl.remove();
            }

            if (selectedBuilding === id) {
                selectedBuilding = null;
            }

            updateBuildingsList();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–¥–∞–Ω–∏–π
        function updateBuildingsList() {
            const listContainer = document.getElementById('buildings-list');
            const actions = document.createElement('div');
            listContainer.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–¥–∞–Ω–∏–π: —Å–Ω–∞—á–∞–ª–∞ –∞–ª—å—è–Ω—Å–∞, –ø–æ—Ç–æ–º –∑–∞–º–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∏–º–µ–Ω–∏
            const sortedBuildings = [...buildings].sort((a, b) => {
                const configA = buildingConfig[a.type];
                const configB = buildingConfig[b.type];

                if (configA.type === 'alliance' && configB.type !== 'alliance') return -1;
                if (configA.type !== 'alliance' && configB.type === 'alliance') return 1;

                if (a.type === 'castle' && b.type === 'castle') {
                    return (a.playerName || '').localeCompare(b.playerName || '');
                }

                return 0;
            });

            sortedBuildings.forEach(building => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.id = `list-item-${building.id}`;
                if (selectedBuilding === building.id) {
                    listItem.classList.add('selected');
                }

                // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–¥–∞–Ω–∏–∏
                const info = document.createElement('div');
                info.innerHTML = `${building.icon} ${translations[currentLang][building.type]}`;
                if (building.type === 'castle' && building.playerName) {
                    info.innerHTML += `: ${building.playerName}`;
                }

                // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
                const actions = document.createElement('div');

                // if (building.type === 'castle') {
                //     const renameBtn = document.createElement('button');
                //     renameBtn.textContent = translations[currentLang].rename;
                //     renameBtn.addEventListener('click', () => showRenameModal(building.id));
                //     actions.appendChild(renameBtn);
                // }

                if (building.type === 'castle' || building.type === 'deadzone') {
                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = translations[currentLang].rename;
                    renameBtn.addEventListener('click', () => showRenameModal(building.id));
                    actions.appendChild(renameBtn);
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = translations[currentLang].delete;
                deleteBtn.addEventListener('click', () => deleteBuilding(building.id));
                actions.appendChild(deleteBtn);

                listItem.appendChild(info);
                listItem.appendChild(actions);

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —â–µ–ª—á–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–¥–∞–Ω–∏—è
                listItem.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        selectBuilding(building.id);
                    }
                });

                listContainer.appendChild(listItem);
            });
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π
        function redrawAllBuildings() {
            // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–¥–∞–Ω–∏–π –∏ –æ–±–ª–∞—Å—Ç–µ–π
            const grid = document.getElementById('grid');
            document.querySelectorAll('.building, .building-area').forEach(el => el.remove());
            // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π –Ω–∞ —Å–µ—Ç–∫—É
            buildings.forEach(building => {
                addBuildingToGrid(building);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateLanguage() {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.getElementById('title').textContent = translations[currentLang].title;
            document.title = translations[currentLang].title;

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
            document.getElementById('buildings-header').textContent = translations[currentLang].buildingsHeader;
            document.getElementById('buildings-list-header').textContent = translations[currentLang].buildingsListHeader;

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.getElementById('modal-title').textContent = translations[currentLang].modalTitle;
            document.getElementById('rename-modal-title').textContent = translations[currentLang].renameModalTitle;

            // –ö–Ω–æ–ø–∫–∏
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            // –ù–∞–∑–≤–∞–Ω–∏—è –∑–¥–∞–Ω–∏–π –≤ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.building-name').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            // –õ–µ–π–±–ª –¥–ª—è –≤–≤–æ–¥–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å–µ—Ç–∫–∏
            document.getElementById('grid-size-label').textContent = translations[currentLang].gridSizeLabel;

            // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
            document.getElementById('playerNameInput').placeholder = translations[currentLang].playerName;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–¥–∞–Ω–∏–π
            updateBuildingsList();

            document.getElementById('saveButton').textContent = translations[currentLang].saveButton;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ base64 –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function saveStateToBase64() {
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è)
            const stateToSave = buildings.map(b => ({
                type: b.type,
                x: b.x,
                y: b.y,
                playerName: b.playerName || '',
                // –î–æ–±–∞–≤–ª—è–µ–º width –∏ height –¥–ª—è –º–µ—Ä—Ç–≤—ã—Ö –∑–æ–Ω
                ...(b.type === 'deadzone' ? { width: b.width, height: b.height } : {})
            }));

            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ JSON –∏ –∑–∞—Ç–µ–º –≤ base64
            const jsonState = JSON.stringify(stateToSave);
            const base64State = btoa(encodeURIComponent(jsonState));

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —Å —Ö—ç—à–µ–º
            const url = `${window.location.origin}${window.location.pathname}#${base64State}`;

            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            navigator.clipboard.writeText(url).then(() => {
                alert(currentLang === 'ru' ? '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!' : 'Link copied to clipboard!');
            }).catch(err => {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É:', err);
                // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                alert(currentLang === 'ru' ?
                    `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í–æ—Ç –≤–∞—à–∞ —Å—Å—ã–ª–∫–∞:\n${url}` :
                    `Failed to copy link automatically. Here is your link:\n${url}`);
            });

            return url;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ base64
        function loadStateFromBase64(base64State) {
            try {
                // –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ base64 –≤ JSON
                const jsonState = decodeURIComponent(atob(base64State));
                const loadedState = JSON.parse(jsonState);

                // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–∏—Ö –∑–¥–∞–Ω–∏–π
                buildings.forEach(b => {
                    const buildingEl = document.getElementById(`building-${b.id}`);
                    if (buildingEl) buildingEl.remove();

                    if (b.areaSize > 0) {
                        const areaEl = document.getElementById(`area-${b.id}`);
                        if (areaEl) areaEl.remove();
                    }
                });

                buildings = [];
                selectedBuilding = null;

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–¥–∞–Ω–∏–π –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                loadedState.forEach(savedBuilding => {
                    const config = buildingConfig[savedBuilding.type];
                    if (!config) return;

                    const newBuilding = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        type: savedBuilding.type,
                        x: savedBuilding.x,
                        y: savedBuilding.y,
                        playerName: savedBuilding.playerName || '',
                        size: config.size,
                        areaSize: config.areaSize,
                        icon: config.icon
                    };

                    buildings.push(newBuilding);
                    addBuildingToGrid(newBuilding);
                });

                updateBuildingsList();
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ location hash –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function checkLocationHash() {
            if (window.location.hash) {
                const base64State = window.location.hash.slice(1); // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª # –∏–∑ –Ω–∞—á–∞–ª–∞
                loadStateFromBase64(base64State);
            }
        }

        function makeDeadZoneResizable(buildingEl, building) {
            if (building.type !== 'deadzone') return;

            // –î–æ–±–∞–≤–∏–º —Å–≤–æ–π—Å—Ç–≤–∞ width –∏ height –≤–º–µ—Å—Ç–æ –µ–¥–∏–Ω–æ–≥–æ size
            if (!building.width) building.width = building.size || 1;
            if (!building.height) building.height = building.size || 1;

            // Create resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            buildingEl.appendChild(resizeHandle);

            // Add resize functionality
            resizeHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation(); // Prevent dragging the building

                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = building.width;
                const startHeight = building.height;

                const handleMouseMove = (moveEvent) => {
                    const deltaX = Math.floor((moveEvent.clientX - startX) / cellSize);
                    const deltaY = Math.floor((moveEvent.clientY - startY) / cellSize);

                    // –û–±–Ω–æ–≤–ª—è–µ–º width –∏ height –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
                    const newWidth = Math.max(1, Math.min(gridSize - building.x, startWidth + deltaX));
                    const newHeight = Math.max(1, Math.min(gridSize - building.y, startHeight + deltaY));

                    building.width = newWidth;
                    building.height = newHeight;

                    // Update the building's visual size
                    buildingEl.style.width = `${building.width * cellSize}px`;
                    buildingEl.style.height = `${building.height * cellSize}px`;
                };

                const handleMouseUp = () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            // Add touch support for resizing
            resizeHandle.addEventListener('touchstart', (e) => {
                e.stopPropagation();

                const touch = e.touches[0];
                const startX = touch.clientX;
                const startY = touch.clientY;
                const startWidth = building.width;
                const startHeight = building.height;

                const handleTouchMove = (touchEvent) => {
                    const touch = touchEvent.touches[0];
                    const deltaX = Math.floor((touch.clientX - startX) / cellSize);
                    const deltaY = Math.floor((touch.clientY - startY) / cellSize);

                    // –û–±–Ω–æ–≤–ª—è–µ–º width –∏ height –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
                    const newWidth = Math.max(1, Math.min(gridSize - building.x, startWidth + deltaX));
                    const newHeight = Math.max(1, Math.min(gridSize - building.y, startHeight + deltaY));

                    building.width = newWidth;
                    building.height = newHeight;

                    buildingEl.style.width = `${building.width * cellSize}px`;
                    buildingEl.style.height = `${building.height * cellSize}px`;
                };

                const handleTouchEnd = () => {
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };

                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
            });
        }

        function setupTouchDragAndDrop() {
            const buildingItems = document.querySelectorAll('.building-item');
            const grid = document.getElementById('grid');

            buildingItems.forEach(item => {
                item.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    item.classList.add('dragging');

                    // –°–æ–∑–¥–∞–µ–º –ø–ª–∞–≤–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = item.querySelector('.building-name').textContent;
                    document.body.appendChild(tooltip);

                    const updateTooltipPosition = (clientX, clientY) => {
                        tooltip.style.position = 'absolute';
                        tooltip.style.left = `${clientX}px`;
                        tooltip.style.top = `${clientY + 30}px`;
                    };

                    const touch = e.touches[0];
                    updateTooltipPosition(touch.clientX, touch.clientY);

                    const handleTouchMove = (moveEvent) => {
                        const touch = moveEvent.touches[0];
                        updateTooltipPosition(touch.clientX, touch.clientY);
                    };

                    const handleTouchEnd = (endEvent) => {
                        item.classList.remove('dragging');
                        document.body.removeChild(tooltip);

                        document.removeEventListener('touchmove', handleTouchMove);
                        document.removeEventListener('touchend', handleTouchEnd);

                        const touch = endEvent.changedTouches[0];
                        const rect = grid.getBoundingClientRect();

                        if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                            touch.clientY >= rect.top && touch.clientY <= rect.bottom) {

                            const x = Math.floor((touch.clientX - rect.left) / cellSize);
                            const y = Math.floor((touch.clientY - rect.top) / cellSize);
                            const type = item.dataset.type;

                            if (type === 'castle') {
                                showPlayerNameModal(x, y);
                            } else {
                                createBuilding(type, x, y);
                            }
                        }
                    };

                    document.addEventListener('touchmove', handleTouchMove);
                    document.addEventListener('touchend', handleTouchEnd);
                });
            });
        }

        function addTouchHandlersToBuilding(buildingEl, building) {
            buildingEl.addEventListener('touchstart', (e) => {
                e.preventDefault();
                selectBuilding(building.id);

                const touch = e.touches[0];
                const startX = touch.clientX;
                const startY = touch.clientY;
                const startBuildingX = building.x;
                const startBuildingY = building.y;

                const handleTouchMove = (moveEvent) => {
                    const touch = moveEvent.touches[0];
                    const deltaX = Math.floor((touch.clientX - startX) / cellSize);
                    const deltaY = Math.floor((touch.clientY - startY) / cellSize);

                    const newX = Math.max(0, Math.min(gridSize - building.size, startBuildingX + deltaX));
                    const newY = Math.max(0, Math.min(gridSize - building.size, startBuildingY + deltaY));

                    // Temporarily remove building for overlap check
                    const index = buildings.findIndex(b => b.id === building.id);
                    const tempBuilding = buildings.splice(index, 1)[0];

                    if (!checkOverlap(newX, newY, building.size)) {
                        building.x = newX;
                        building.y = newY;
                        updateBuilding(building);
                    }

                    // Return building to array
                    buildings.splice(index, 0, tempBuilding);
                };

                const handleTouchEnd = () => {
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };

                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
            });
        }

        function setupTouchEvents() {
            const gridContainer = document.querySelector('.grid-container');
            let initialDistance = 0;
            let initialCellSize = cellSize;

            gridContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    initialCellSize = cellSize;
                }
            });

            gridContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault(); // Prevent page scrolling

                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );

                    const scaleFactor = currentDistance / initialDistance;
                    cellSize = Math.max(6, Math.min(36, initialCellSize * scaleFactor));

                    setupGrid();
                    redrawAllBuildings();
                }
            });
        }

        function checkScreenSize() {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            document.body.classList.toggle('mobile-view', isMobile);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
            if (isMobile) {
                // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏
                document.querySelectorAll('.building-item .building-name').forEach(name => {
                    name.dataset.originalText = name.textContent;
                });
            } else {
                // –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                document.querySelectorAll('.building-item .building-name').forEach(name => {
                    if (name.dataset.originalText) {
                        name.textContent = name.dataset.originalText;
                    }
                });
            }
        }
    </script>
</body>
    
</html>
